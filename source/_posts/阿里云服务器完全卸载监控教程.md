---
title: 阿里云服务器完全卸载监控教程
tags: ["Linux"]
categories: Linux
date: 2018-09-17
grammar_cjkRuby: true
copyright: ture
---

阿里云的服务器都自带监控（AliYunDun/阿里云盾/安骑士教程），大家都不想自己的所作所为都被监控着。
 <!-- more -->

### SSH连接阿里云服务器

```shell
ssh root@[address]
```

然后输入密码，即可。

### 在终端中输入下方命令，进行卸载AliYunDun操作

```shell
wget http://update.aegis.aliyun.com/download/uninstall.sh && chmod +x uninstall.sh && ./uninstall.sh
wget http://update.aegis.aliyun.com/download/quartz_uninstall.sh && chmod +x quartz_uninstall.sh && ./quartz_uninstall.sh
```

### 停止agentwatch.service服务（阿里云盾的监控进程）

```shell
systemctl stop agentwatch.service
```

### 禁止agentwatch.service服务启动

```shell
systemctl disable agentwatch.service
```

### 回到根目录

```shell
cd /
```

### 删除agentwatch.service相关服务

```shell
find . -name 'agentwatch*' -type d -exec rm -rf {} \; && find . -name 'agentwatch*' -type f -exec rm -rf {} \;
```

### 强行停止aliyun-service服务

```shell
pkill aliyun-service
```

### 清理所有带aliyun、aegis关键字的文件

```shell
find . -name 'aliyun*' -type d -exec rm -rf {} \;
find . -name 'aliyun*' -type f -exec rm -rf {} \;
find . -name 'aegis*' -type f -exec rm -rf {} \;
find . -name 'aegis*' -type d -exec rm -rf {} \;
rm -fr /usr/sbin/aliyun-service /usr/sbin/aliyun_installer
```

### 一些未触发关键字，但属于阿里云夹带私货的服务

阿里云还偷偷内置了一堆服务，虽然没有注册到系统里且启动，但为了保险起见，还是将它们一并删除的比较好，有关内置服务的详情，参见：[阿里云服务删除](https://gist.github.com/shui/748e436b92055634d2160367d0161c8d)

可疑服务有以下几个，有5个位于/etc/systemd/system/multi-user.target.wants/目录下，均以“cloud-”打头的五个服务：

```shell
find /etc/systemd/system/ -name 'cloud-*' | xargs rm -rf
```

还有一个是位于/lib/systemd/system/目录下的“accounts-daemon.service”文件。
**注意**，删除掉这个，你就无法通过阿里云控制台的VNC面板为机器修改ssh密码、查看机器的详细运行状态了，请谨慎决定是否需要删除（不推荐）：

```shell
rm -fr /lib/systemd/system/accounts-daemon.service
```

将以上组件删除后，阿里云后面板监控中的操作系统监控和进程监控都变为**不可用**。

### 禁止所有与阿里云监控相关的IP访问

#### 利用阿里云安全组规则屏蔽相关IP

进入云服务器，选择网络与安全，点击配置规则，点击添加安全组规则，各个项目照着填，授权对象填以下这些IP（摘自上面那个阿里云的官网），最后一个“描述”填“屏蔽阿里云盾监控”，点“确定”就行了。

> 140.205.201.0/28,140.205.201.16/29,140.205.201.32/28,140.205.225.192/29,140.205.225.200/30,140.205.225.184/29,140.205.225.183/32,140.205.225.206/32,140.205.225.205/32,140.205.225.195/32,140.205.225.204/32,106.11.224.0/26,106.11.224.64/26,106.11.224.128/26,106.11.224.192/26,106.11.222.64/26,106.11.222.128/26,106.11.222.192/26,106.11.223.0/26,140.205.201.0/24,140.205.225.0/24

同理，阿里云监测IP也要并到这个安全组规则里面来，以下是待屏蔽的IP：

> 112.124.127.224,112.124.127.44,112.124.127.64,112.124.127.53,120.26.216.168,120.26.64.126,121.43.107.174,121.43.105.176,121.41.117.242,121.40.130.38,121.41.112.148,115.29.112.222,115.28.203.70,42.96.189.63,115.29.113.101,120.27.40.113,115.28.171.22,115.28.189.208,121.42.196.232,115.28.26.13,120.27.47.144,120.27.47.33,112.126.74.55,182.92.148.207,182.92.1.233,112.126.73.56,123.56.138.37,123.57.10.133,112.126.75.174,182.92.157.118,112.126.75.221,182.92.69.212,10.153.174.11,10.153.175.147,10.153.175.146,110.75.0.0/16,42.120.0.0/16

出方向允许全部就ok，反正我们主要防止的是阿里云的IP主动来找我们机器的麻烦。

安全组规则入方向的屏蔽阿里云监测IP添加完成了，我们再逐条添加常用的443、、80、3306等端口放行规则。

#### 机器内部配置防火墙

对于`Ubuntu`系统，可以考虑开启`UFW`防火墙，只开放ssh登陆端口和攀云屐端口，在系统防火墙里添加如下规则，彻底锁死阿里云的IP主动探测我们的机器。

##### 安装ufw：

```shell
apt-get install ufw
```

##### 开启ufw：

```shell
ufw enable
```

##### 编辑配置文件

如果你的机器自带IPv6地址，确保 IPV6=yes 这个值生效：

```shell
vim /etc/default/ufw
```

##### 设置基本的出入站规则

入站（备注，默认禁止所有端口访问，后面我们会预留必要的端口）：

```shell
ufw default deny incoming
```

出站（备注，默认允许服务器访问所有端口）：

```shell
ufw default allow outgoing
```

出站规则我们就不用再做其他的额外设置了，主要做入站的端口规则，打开各种必要的端口，对于我的阿里云来说，平时打开ssh登陆端口和其他访问端口就够了：

```shell
ufw allow 22/tcp
```

ssh登陆端口是一定要放行的，否则等会儿机器都连不上了。

##### 在ufw里添加规则

彻底禁止阿里云的检测节点IP来骚扰我们的机器：

```shell
vim /etc/ufw/before.rules
```

找到 ## End required lines ，添加如下：

> -A ufw-before-input -s 140.205.201.0/24 -j DROP
> -A ufw-before-input -s 140.205.201.0/28 -j DROP
> -A ufw-before-input -s 140.205.201.16/29 -j DROP
> -A ufw-before-input -s 140.205.201.32/28 -j DROP
> -A ufw-before-input -s 140.205.225.0/24 -j DROP
> -A ufw-before-input -s 140.205.225.192/29 -j DROP
> -A ufw-before-input -s 140.205.225.200/30 -j DROP
> -A ufw-before-input -s 140.205.225.184/29 -j DROP
> -A ufw-before-input -s 140.205.225.183/32 -j DROP
> -A ufw-before-input -s 140.205.225.206/32 -j DROP
> -A ufw-before-input -s 140.205.225.205/32 -j DROP
> -A ufw-before-input -s 140.205.225.195/32 -j DROP
> -A ufw-before-input -s 140.205.225.204/32 -j DROP
> -A ufw-before-input -s 106.11.224.0/26 -j DROP
> -A ufw-before-input -s 106.11.224.64/26 -j DROP
> -A ufw-before-input -s 106.11.224.128/26 -j DROP
> -A ufw-before-input -s 106.11.224.192/26 -j DROP
> -A ufw-before-input -s 106.11.222.64/26 -j DROP
> -A ufw-before-input -s 106.11.222.128/26 -j DROP
> -A ufw-before-input -s 106.11.222.192/26 -j DROP
> -A ufw-before-input -s 106.11.223.0/26 -j DROP
> -A ufw-before-input -s 112.124.127.224 -j DROP
> -A ufw-before-input -s 112.124.127.44 -j DROP
> -A ufw-before-input -s 112.124.127.64 -j DROP
> -A ufw-before-input -s 112.124.127.53 -j DROP
> -A ufw-before-input -s 120.26.216.168 -j DROP
> -A ufw-before-input -s 120.26.64.126 -j DROP
> -A ufw-before-input -s 121.43.107.174 -j DROP
> -A ufw-before-input -s 121.43.107.176 -j DROP
> -A ufw-before-input -s 121.41.117.242 -j DROP
> -A ufw-before-input -s 121.40.130.38 -j DROP
> -A ufw-before-input -s 121.41.112.148 -j DROP
> -A ufw-before-input -s 115.29.112.222 -j DROP
> -A ufw-before-input -s 115.28.203.70 -j DROP
> -A ufw-before-input -s 42.96.189.63 -j DROP
> -A ufw-before-input -s 115.29.113.101 -j DROP
> -A ufw-before-input -s 120.27.40.113 -j DROP
> -A ufw-before-input -s 115.28.171.22 -j DROP
> -A ufw-before-input -s 115.28.189.208 -j DROP
> -A ufw-before-input -s 121.42.196.232 -j DROP
> -A ufw-before-input -s 115.28.26.13 -j DROP
> -A ufw-before-input -s 120.27.47.144 -j DROP
> -A ufw-before-input -s 120.27.47.33 -j DROP
> -A ufw-before-input -s 112.126.74.55 -j DROP
> -A ufw-before-input -s 182.92.148.207 -j DROP
> -A ufw-before-input -s 182.92.1.233 -j DROP
> -A ufw-before-input -s 112.126.73.56 -j DROP
> -A ufw-before-input -s 123.56.138.37 -j DROP
> -A ufw-before-input -s 123.57.10.133 -j DROP
> -A ufw-before-input -s 112.126.75.174 -j DROP
> -A ufw-before-input -s 182.92.157.118 -j DROP
> -A ufw-before-input -s 112.126.75.221 -j DROP
> -A ufw-before-input -s 182.92.69.212 -j DROP
> -A ufw-before-input -s 10.153.174.11 -j DROP
> -A ufw-before-input -s 10.153.175.147 -j DROP
> -A ufw-before-input -s 10.153.175.146 -j DROP
> -A ufw-before-input -s 110.75.0.0/16 -j DROP
> -A ufw-before-input -s 42.120.0.0/16 -j DROP

确认、保存退出。

##### 重载ufw配置，使其生效

```shell
ufw reload
```

### 卸载云监控Java版本插件

```shell
sudo /usr/local/cloudmonitor/wrapper/bin/cloudmonitor.sh stop
sudo /usr/local/cloudmonitor/wrapper/bin/cloudmonitor.sh remove
sudo rm -rf /usr/local/cloudmonitor
```
### 卸载云监控 Go 语言版
```shell
sudo /usr/local/cloudmonitor/CmsGoAgent.linux-amd64 stop
sudo /usr/local/cloudmonitor/CmsGoAgent.linux-amd64 uninstall
sudo rm -rf /usr/local/cloudmonitor
```